# -*- coding: utf-8 -*-
# vi: set ft=python :

import os
from cdiscountapi.cdiscountapi import Connection
from functools import lru_cache
from collections import defaultdict
from pathlib import Path
import konch
import yaml
from lxml import etree
from tabulate import tabulate
import time
import json
import operator


# CONSTANTS
METADATA_DIR = 'personal/scripts/metadata'


@lru_cache(maxsize=128)
def get_tree(api):
    tree = api.products.get_allowed_category_tree()
    return tree['CategoryTree']['ChildrenCategoryList']['CategoryTree']


def walk_tree(tree):
    graph = {}
    for branch in tree:
        name = branch['Name']
        if branch.get('ChildrenCategoryList', {}) is not None:
            graph[name] = walk_tree(branch['ChildrenCategoryList']['CategoryTree'])
        else:
            graph[name] = branch['Code']
    return graph


def analyze_preprod_choice(value):
    """
    value must be '0' (False) or '1' (True)
    """
    if value not in ('0', '1'):
        raise ValueError('value must be "0" (False) or "1" (True)')
    return bool(int(value))


def load_cassette(cassette_name):
    """
    Load the cassette saved in yaml by vcrpy

    :param cassette_name: The name of the cassette
    :type cassette_name: str
    :return: the data contained in the cassette
    """
    fname = Path("cdiscountapi/tests/cassettes").joinpath(cassette_name)
    if not fname.exists():
        raise Exception(f'{fname} does not exist.')
    return yam.load(fname.read_text())


def create_request(api, operation, **kwargs):
    """
    Example
    >>> element = create_request(api, 'GetProductList',
                                 productFilter={'CategoryCode': '42'})
    """
    return api.client.create_message(api.client.service, operation,
                                     headerMessage=api.header, **kwargs)


def show_request(api, operation, **kwargs):
    request = create_request(api, operation, **kwargs)
    print(etree.tostring(request, pretty_print=True).decode('utf8'))


def show_offers_list(offers_list):
    """
    Usage:
        offers_list = api.get_offers_list_paginated(PageNumber=1)
        show_offers_list(offers_list)
    """
    header = ['SellerProductId', 'ProductEan', 'ProductCondition', 'Price',
              'CreationDate', 'OfferState', 'LastUpdateDate']
    header_fn = operator.itemgetter(*header)
    table = [dict(zip(header, header_fn(x))) for x in offers_list['OfferList']['Offer']]
    print(tabulate(table, headers="keys"))


def show_offer_package_submission_results(api):
    """
    Usage:
        show_offer_package_submission_results(api)
    """
    metadata = Path().cwd().joinpath(METADATA_DIR)
    if not metadata.exists():
        raise ValueError(f"Can't find the metadata directory {metadata}")

    def fromepoch(epoch):
        return time.strftime("%Y-%m-%d %H:%M:%S", time.localtime(epoch)) 

    def make_row(content):
        row = {}
        row['PackageId'] = content['response']['PackageId']
        row['Success'] = content['response']['OperationSuccess']
        row['SellerProductIds'] = ','.join(x['data']['SellerProductId'] for x in content['offers'])
        row['PackageName'] = content['base_package_name']
        row['Date'] = fromepoch(content['timestamp'])
        submission_result = api.offers.get_offer_package_submission_result(
            int(row['PackageId'])
        )
        row['Status'] = submission_result['PackageIntegrationStatus']
        row['Comment'] = content['comment'][0:42]
        return row

    table = []
    for f in metadata.iterdir():
        content = json.loads(f.read_text())
        table.append(make_row(content))
    print(tabulate(table, headers='keys'))


cdiscount_api_preprod = os.getenv('CDISCOUNT_API_PREPROD')
preprod = analyze_preprod_choice(cdiscount_api_preprod) if\
    cdiscount_api_preprod else False

if preprod:
    banner = '==Preprod environment for Cdiscount=='
else:
    banner = '**Production environment for Cdiscount**'

header_message = {
    'Context': {
        'SiteID': 100,
        'CatalogID': 1
    },
    'Localization': {
        'Country': 'Fr',
        'Currency': 'Eur',
    },
    'Security': {
        'IssuerID': None,
        'SessionID': None,
        'UserName': '',
    },
    'Version': 1.0,
}

# Available options:
#   'context', 'banner', 'shell', 'prompt', 'output',
#   'context_format', 'ipy_extensions', 'ipy_autoreload',
#   'ipy_colors', 'ipy_highlighting_style'

konch.config({
    'banner': banner,
    'context': {
        'api': Connection(os.getenv('CDISCOUNT_API_LOGIN'),
                          os.getenv('CDISCOUNT_API_PASSWORD'),
                          preprod=preprod,
                          header_message=header_message),
        'get_tree': get_tree,
        'load_cassette': load_cassette,
        'create_request': create_request,
        'show_request': show_request,
        'show_offers_list': show_offers_list,
        'show_offer_package_submission_results': show_offer_package_submission_results
    },
    "shell": "ipython",
    "ipy_autoreload": True,
})


def setup():
    pass


def teardown():
    pass


# Helpers
